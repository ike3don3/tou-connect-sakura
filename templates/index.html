<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOU Connect - æ±äº¬é€šä¿¡å¤§å­¦ å­¦å‹ãƒãƒƒãƒãƒ³ã‚°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
    <meta name="description" content="æ±äº¬é€šä¿¡å¤§å­¦ã®å­¦ç”ŸåŒå£«ã‚’ã¤ãªãAIæ´»ç”¨ãƒãƒƒãƒãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ">
    <meta property="og:title" content="TOU Connect - å­¦å‹ãƒãƒƒãƒãƒ³ã‚°">
    <meta property="og:description" content="AIåˆ†æã§æœ€é©ãªå­¦ç¿’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¦‹ã¤ã‘ã‚ˆã†">
    <meta property="og:type" content="website">
    <meta property="og:image" content="{{ url_for('static', filename='images/og-image.jpg', _external=True) }}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="theme-color" content="#6366f1">
</head>
<body class="scroll-container ios-safe-area">
    <div class="main-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <h1 class="main-title">ğŸ“ TOU Connect</h1>
            <p class="subtitle">æ±äº¬é€šä¿¡å¤§å­¦ <span class="highlight-word">å­¦å‹ãƒãƒƒãƒãƒ³ã‚°</span>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
        </header>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="card">
            <div class="nav-buttons flex-mobile-column">
                <a href="/matching" class="btn btn-success">
                    <i class="fas fa-handshake icon-highlighted"></i>
                    <span class="desktop-only">å­¦å‹ãƒãƒƒãƒãƒ³ã‚°</span>
                    <span class="mobile-only tablet-only">ãƒãƒƒãƒãƒ³ã‚°</span>
                </a>
                <a href="/resources" class="btn btn-warning">
                    <i class="fas fa-book icon-highlighted"></i>
                    <span class="desktop-only">å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹</span>
                    <span class="mobile-only tablet-only">ãƒªã‚½ãƒ¼ã‚¹</span>
                </a>
                <a href="/monitoring" class="btn btn-primary">
                    <i class="fas fa-chart-line icon-highlighted"></i>
                    <span class="desktop-only">ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–</span>
                    <span class="mobile-only tablet-only">ç›£è¦–</span>
                </a>
            </div>
        </nav>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="card">
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-search icon-primary"></i>
                    ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ†æ
                </h2>
                <p class="section-description">
                    X(Twitter)ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’<span class="highlight-word">AIåˆ†æ</span>ã—ã¦ã€æœ€é©ãªå­¦ç¿’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†
                </p>
                
                <form id="analysis-form" class="analysis-form">
                    <div class="form-group">
                        <label for="username" class="form-label">
                            <i class="fab fa-twitter"></i>
                            Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆå
                        </label>
                        <input 
                            type="text" 
                            id="username" 
                            class="form-input" 
                            placeholder="@username ã¾ãŸã¯ username" 
                            autocomplete="off"
                            required
                        />
                        <small class="form-help">ä¾‹: @yamada_taro ã¾ãŸã¯ yamada_taro</small>
                        <div id="usernameFeedback" class="input-feedback"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-large">
                        <i class="fas fa-search icon-highlighted"></i>
                        <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ†æ</span>
                    </button>
                </form>
            </div>
        </main>
        
        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="result-container" class="result-container" style="display: none;">
            <div class="card">
                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
                <div id="loading" class="loading-state" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>ï¿½ åˆ†æä¸­...</p>
                    <small>å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</small>
                </div>
                
                <!-- åˆ†æçµæœ -->
                <div id="analysis-result" class="analysis-result"></div>
            </div>
        </div>

        <!-- æ©Ÿèƒ½ç´¹ä»‹ -->
        <section class="feature-section">
            <h2 class="section-title text-center">TOU Connect ã®<span class="highlight-word">ç‰¹å¾´</span></h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-brain icon-accent"></i>
                    </div>
                    <h3>AIåˆ†æ</h3>
                    <p>æœ€æ–°ã®AIæŠ€è¡“ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è©³ç´°åˆ†æã—ã€<span class="highlight-word">å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«</span>ã‚„èˆˆå‘³ã‚’æŠŠæ¡ã—ã¾ã™</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-users icon-accent"></i>
                    </div>
                    <h3>ã‚¹ãƒãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°</h3>
                    <p>ç›¸æ€§ã®è‰¯ã„<span class="highlight-word">å­¦ç¿’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</span>ã‚’è‡ªå‹•ã§ç™ºè¦‹ã—ã€åŠ¹æœçš„ãªå­¦ç¿’ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt icon-accent"></i>
                    </div>
                    <h3>å®‰å…¨ãƒ»å®‰å¿ƒ</h3>
                    <p><span class="highlight-word">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·</span>ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æœ€å„ªå…ˆã«ã€å®‰å…¨ãªå­¦ç¿’ç’°å¢ƒã‚’æä¾›</p>
                </div>
            </div>
        </section>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">
                        <i class="fas fa-shield-alt icon-primary"></i>
                        ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
                    </a>
                    <a href="/terms" class="footer-link">
                        <i class="fas fa-file-contract icon-primary"></i>
                        åˆ©ç”¨è¦ç´„
                    </a>
                    <a href="/health" class="footer-link">
                        <i class="fas fa-heartbeat icon-primary"></i>
                        ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
                    </a>
                </div>
                <div class="footer-copyright">
                    <p>Â© 2024 TOU Connect. All rights reserved.</p>
                    <p class="mobile-hidden">æ±äº¬é€šä¿¡å¤§å­¦ <span class="highlight-word">å­¦å‹ãƒãƒƒãƒãƒ³ã‚°</span>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®JavaScript
        const AnalysisApp = {
            init() {
                this.bindEvents();
                this.setupResponsiveFeatures();
            },

            bindEvents() {
                const form = document.getElementById('analysis-form');
                const usernameInput = document.getElementById('username');
                
                form.addEventListener('submit', this.handleSubmit.bind(this));
                usernameInput.addEventListener('keypress', this.handleKeyPress.bind(this));
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
                usernameInput.addEventListener('input', this.validateUsername.bind(this));
                usernameInput.addEventListener('blur', this.validateUsername.bind(this));
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ï¼ˆç”»é¢å›ºå®šå•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚æœ€å°é™ã«ï¼‰
                // window.addEventListener('resize', this.handleResize.bind(this));
            },

            setupResponsiveFeatures() {
                // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º
                if ('ontouchstart' in window) {
                    document.body.classList.add('touch-device');
                }
                
                // PWAå¯¾å¿œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                if ('serviceWorker' in navigator) {
                    this.registerServiceWorker();
                }
                
                // åˆæœŸviewportèª¿æ•´ã‚’å®‰å…¨ã«å®Ÿè¡Œ
                this.safeViewportAdjustment();
            },
            
            safeViewportAdjustment() {
                // å®‰å…¨ãªãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆèª¿æ•´
                try {
                    // ãƒ¢ãƒã‚¤ãƒ« Safari ã® 100vh å•é¡Œå¯¾ç­–
                    if (window.innerHeight > 0) {
                        const vh = window.innerHeight * 0.01;
                        document.documentElement.style.setProperty('--safe-vh', `${vh}px`);
                    }
                } catch (error) {
                    console.warn('Viewport adjustment failed:', error);
                }
            },

            handleSubmit(e) {
                e.preventDefault();
                this.analyzeAccount();
            },

            handleKeyPress(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.analyzeAccount();
                }
            },
            
            validateUsername(e) {
                try {
                    const input = e.target;
                    const feedback = document.getElementById('usernameFeedback');
                    
                    if (!input || !feedback) {
                        console.error('Required elements not found');
                        return;
                    }
                    
                    let value = input.value.trim();
                    
                    // @ãƒãƒ¼ã‚¯ã‚’è‡ªå‹•ã§å‰Šé™¤
                    if (value.startsWith('@')) {
                        value = value.substring(1);
                        input.value = value;
                    }
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢
                    feedback.className = 'input-feedback';
                    feedback.textContent = '';
                    
                    if (value === '') {
                        return; // ç©ºã®å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
                    }
                    
                    // Twitter ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®æ¤œè¨¼ãƒ«ãƒ¼ãƒ« - ã‚ˆã‚Šå³å¯†ãªæ¤œè¨¼
                    let isValid = false;
                    try {
                        // æ­£è¦è¡¨ç¾ã‚’å®‰å…¨ã«ä½œæˆ
                        const pattern = /^[a-zA-Z0-9_]{1,15}$/;
                        isValid = pattern.test(value);
                        console.log('Regex test:', { value, pattern: pattern.toString(), isValid });
                    } catch (regexError) {
                        console.error('Regex error:', regexError);
                        isValid = false;
                    }
                    
                    if (isValid) {
                        feedback.className = 'input-feedback success';
                        feedback.innerHTML = '<i class="fas fa-check-circle"></i> æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã™';
                    } else {
                        feedback.className = 'input-feedback error';
                        
                        if (value.length > 15) {
                            feedback.innerHTML = '<i class="fas fa-exclamation-circle"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯15æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                        } else {
                            try {
                                const basicPattern = /^[a-zA-Z0-9_]+$/;
                                if (!basicPattern.test(value)) {
                                    feedback.innerHTML = '<i class="fas fa-exclamation-circle"></i> è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢(_)ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™';
                                } else {
                                    feedback.innerHTML = '<i class="fas fa-exclamation-circle"></i> ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã™';
                                }
                            } catch (basicRegexError) {
                                console.error('Basic regex error:', basicRegexError);
                                feedback.innerHTML = '<i class="fas fa-exclamation-circle"></i> ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã™';
                            }
                        }
                    }
                    
                    console.log('Username validation:', { value, isValid });
                } catch (error) {
                    console.error('Username validation error:', error);
                }
            },
            
            safeSmoothScroll(element) {
                // å®‰å…¨ãªã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè£…
                try {
                    if (element && typeof element.scrollIntoView === 'function') {
                        // requestAnimationFrame ã‚’ä½¿ç”¨ã—ã¦å®‰å…¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        requestAnimationFrame(() => {
                            element.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start',
                                inline: 'nearest'
                            });
                        });
                    }
                } catch (error) {
                    console.warn('Smooth scroll failed, using fallback:', error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    if (element) {
                        element.scrollIntoView();
                    }
                }
            },

            handleResize() {
                // ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†ï¼ˆç”»é¢å›ºå®šã‚’å›é¿ã™ã‚‹ãŸã‚æœ€å°é™ã«ï¼‰
                // this.updateViewport(); // ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
            },

            updateViewport() {
                // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚µã‚¤ã‚ºã«å¿œã˜ãŸå‹•çš„èª¿æ•´ï¼ˆå•é¡Œå›é¿ã®ãŸã‚ç„¡åŠ¹åŒ–ï¼‰
                // const vh = window.innerHeight * 0.01;
                // document.documentElement.style.setProperty('--vh', `${vh}px`);
            },

            async analyzeAccount() {
                const username = document.getElementById('username').value.trim();
                const resultContainer = document.getElementById('result-container');
                const loadingDiv = document.getElementById('loading');
                const analysisDiv = document.getElementById('analysis-result');
                
                if (!username) {
                    this.showNotification('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®æ¤œè¨¼ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                const cleanUsername = username.replace(/^@/, '');
                
                // åŸºæœ¬çš„ãªæ¤œè¨¼ - å®‰å…¨ãªæ­£è¦è¡¨ç¾ä½¿ç”¨
                try {
                    const validationPattern = /^[a-zA-Z0-9_]{1,15}$/;
                    if (!validationPattern.test(cleanUsername)) {
                        this.showNotification('ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã™ï¼ˆè‹±æ•°å­—ã¨_ã®ã¿ã€1-15æ–‡å­—ï¼‰', 'error');
                        return;
                    }
                } catch (validationError) {
                    console.error('Validation pattern error:', validationError);
                    this.showNotification('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®æ¤œè¨¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                    return;
                }
                
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
                document.getElementById('username').value = cleanUsername;
                
                // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                resultContainer.style.display = 'block';
                loadingDiv.style.display = 'block';
                analysisDiv.innerHTML = '';
                
                // å®‰å…¨ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                this.safeSmoothScroll(resultContainer);
                
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username: cleanUsername })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    }
                    
                    this.displayResults(data.analysis);
                    this.showNotification('åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.displayError(error.message);
                } finally {
                    loadingDiv.style.display = 'none';
                }
            },

            displayResults(data) {
                const analysisDiv = document.getElementById('analysis-result');
                
                let matchesHtml = '';
                if (data.matches && data.matches.length > 0) {
                    matchesHtml = `
                        <div class="matches-section">
                            <h4><i class="fas fa-handshake"></i> å­¦å‹ãƒãƒƒãƒãƒ³ã‚°å€™è£œ</h4>
                            <div class="matches-grid">
                                ${data.matches.map(match => `
                                    <div class="match-card">
                                        <div class="match-header">
                                            <strong>${match.display_name}</strong>
                                            <span class="username">@${match.username}</span>
                                        </div>
                                        <div class="compatibility-score">${match.compatibility_score}%</div>
                                        <div class="match-reasons">
                                            ${match.match_reasons.map(reason => `<span class="reason-tag">${reason}</span>`).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // åˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ”¹å–„
                let analysisHtml = '';
                if (data.analysis) {
                    const analysis = data.analysis;
                    analysisHtml = `
                        <div class="analysis-section">
                            <h4><i class="fas fa-brain"></i> AIåˆ†æçµæœ</h4>
                            <div class="analysis-content">
                                <div class="analysis-item">
                                    <label>èˆˆå‘³ãƒ»é–¢å¿ƒ</label>
                                    <div class="tags">
                                        ${analysis.interests ? analysis.interests.map(interest => `<span class="tag">${interest}</span>`).join('') : ''}
                                    </div>
                                </div>
                                <div class="analysis-item">
                                    <label>å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«</label>
                                    <span>${analysis.learning_style || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                                </div>
                                <div class="analysis-item">
                                    <label>æ€§æ ¼ç‰¹æ€§</label>
                                    <div class="tags">
                                        ${analysis.personality_traits ? analysis.personality_traits.map(trait => `<span class="tag">${trait}</span>`).join('') : ''}
                                    </div>
                                </div>
                                <div class="analysis-item">
                                    <label>å­¦ç¿’ã®å¥½ã¿</label>
                                    <div class="tags">
                                        ${analysis.study_preferences ? analysis.study_preferences.map(pref => `<span class="tag">${pref}</span>`).join('') : ''}
                                    </div>
                                </div>
                                <div class="analysis-item">
                                    <label>æ´»å‹•ãƒ¬ãƒ™ãƒ«</label>
                                    <span>${analysis.activity_level || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                                </div>
                                <div class="analysis-item">
                                    <label>æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
                                    <span>${analysis.engagement_pattern || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                analysisDiv.innerHTML = `
                    <div class="result-header">
                        <h3><i class="fas fa-chart-bar"></i> @${data.username} ã®åˆ†æçµæœ</h3>
                        ${data.api_note ? `<div class="api-notice"><i class="fas fa-info-circle"></i> ${data.api_note}</div>` : ''}
                    </div>
                    
                    <div class="account-info-section">
                        <h4><i class="fas fa-user"></i> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>è¡¨ç¤ºå</label>
                                <span>${data.display_name}</span>
                            </div>
                            ${!data.api_note && typeof data.followers_count === 'number' ? `
                            <div class="info-stats">
                                <div class="stat-item">
                                    <span class="stat-number">${data.followers_count.toLocaleString()}</span>
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${data.following_count.toLocaleString()}</span>
                                    <span class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¼</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${data.tweets_count.toLocaleString()}</span>
                                    <span class="stat-label">ãƒ„ã‚¤ãƒ¼ãƒˆ</span>
                                </div>
                            </div>
                            ` : `
                            <div class="api-limit-notice">
                                <i class="fas fa-clock"></i>
                                <p>ç¾åœ¨ã€Twitter APIåˆ¶é™ã«ã‚ˆã‚Šè©³ç´°ãªçµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚</p>
                                <small>æ¨å®šã«åŸºã¥ãåˆ†æã¨ãƒãƒƒãƒãƒ³ã‚°çµæœã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</small>
                            </div>
                            `}
                            <div class="info-item">
                                <label>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</label>
                                <span>${data.account_created}</span>
                            </div>
                            ${!data.api_note && data.description && !data.description.includes("Twitter APIåˆ¶é™") ? `
                            <div class="info-item">
                                <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
                                <span>${data.description}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${analysisHtml}
                    
                    ${matchesHtml}
                    
                    <div class="save-notification">
                        <i class="fas fa-save"></i>
                        <span>åˆ†æçµæœã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ</span>
                    </div>
                `;
                
                this.showNotification('åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            },

            displayError(message) {
                const analysisDiv = document.getElementById('analysis-result');
                analysisDiv.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>ã‚¨ãƒ©ãƒ¼: ${message}</span>
                    </div>
                `;
                this.showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            },

            showNotification(message, type = 'info') {
                // Toasté€šçŸ¥ã®å®Ÿè£…
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${this.getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            },

            getNotificationIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            },

            async registerServiceWorker() {
                try {
                    await navigator.serviceWorker.register('/static/js/sw.js');
                } catch (error) {
                    console.log('ServiceWorker registration failed');
                }
            }
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            AnalysisApp.init();
        });

        // ãƒ¬ã‚¬ã‚·ãƒ¼é–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        function analyzeAccount() {
            AnalysisApp.analyzeAccount();
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚¨ãƒ©ãƒ¼ç›£è¦–å¼·åŒ–
        window.addEventListener('error', function(e) {
            console.error('Script error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error,
                stack: e.error ? e.error.stack : null
            });
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
            if (e.message && e.message.includes('pattern')) {
                console.error('PATTERN ERROR DETECTED:', e.message);
                alert('æ­£è¦è¡¨ç¾ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: ' + e.message);
            }
        });

        // æœªå‡¦ç†ã®Promiseæ‹’å¦ã‚‚ã‚­ãƒ£ãƒƒãƒ
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // Bootstrapç¢ºèª
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded!');
                alert('Bootstrap CSSãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åŒæ„æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            } else {
                console.log('Bootstrap loaded successfully');
            }
        });
    </script>

    <!-- åŒæ„å–å¾—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    {% include 'consent_modal_simple.html' %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>